\chapter[SSR characterization]{Characterization of the spatial system response}\label{chap:sysresp}
\section{Knife edge measurements}\label{sec:kedgemeasurements}
In this section the acquisition of the data and the resulting outcome for the measurements with a knife edge is presented. At the end of the chapter a comparison between this technique and the one presented in section \ref{sec:targetmeasurements} is given. 
\subsection{Data acquisition}\label{subsec:knifedata}
The characterization of the response of a system can be described in the spatial domain as well as in the frequency domain, but of course with the Fourier transform the transition between these two spaces is very easy. This section therefore focusses only on the spatial domain, because the main interest lies on the determination of the source size in different directions. There are several methods to determine the spot size of the source e.g. with thin slits, rods or pin-holes etc. For a detailed overview about the different methods and corresponding norms see: \citep{Bavendiek2012} or \acrshort{en},\acrshort{astm},\acrshort{iec}. The most common way to determine this property is to use a sharp edge, which is projected onto the detector screen. This projected edge-profile is also known as the \gls{esf} described in section \ref{subsec:esflsf}.   
\begin{figure}%[h]
	\begin{center}
		\includegraphics[width = 14.7cm,keepaspectratio =true]{edgeimages}
	\end{center}
	\caption[Pictures of the knife edge and corresponding projection image]{\textit{a) Image of a projected edge required of the detector. The edge is slightly tilted ($\approx 3\,$째) for the images to provide afterwards at the data-processing a sub-pixel resolution. b) Two pictures of the cuboid with the edge profile on two opposite sides. The two thin sides of the cuboid are polished, to get a smoother surface and thus a sharper edge.}}
	\label{edgeimages}
\end{figure}
A image of such a sharp edge and their corresponding projection is shown in Figure \ref{edgeimages}. a) shows the projection image of the edge, which was taken at a photon energy of $60\,$keV, a power of $80\,$W and with a magnification of $24.45$. As one can clearly see is the edge smeared out over several pixels, due to the geometrical unsharpness induced by the limited spot size. b) shows the edge which has a polished side to smooth the surface and hence improve the sharpness of the edge. To reinforce the contrast in the projection image, the cuboid containing the edge has a thickness of $5\,$mm and is made of stainless steel, because of its good absorption properties up to high photon-energies and the possibility to easily polish the surface. Usually the thickness of such edges is thinner, because the thinner the edge the less the influence of a misalignment of the edge onto the measurement. But as shown in section \ref{subsec:weth} the influence of the edge-thickness is negligible over a broad range, preconditioned that the edge is positioned perpendicular to the beam.
\paragraph{Edge alignment} \label{alignment}
To fulfil this condition the edge is positioned on the Euler-cradle and first aligned by hand to be perpendicular to the beam. After that the centre of the beam on the detector screen is determined with a small python script. To adjust the edge as perpendicular to the beam as possible, the edge is at first positioned at a certain distance apart from the source right in the centre of the beam. After that the edge is rotated around its own y-axis. Hence, the edge is on purpose misaligned in certain angle steps with respect to the z-axis. At each of this angles a image is taken and corrected with a \gls{flat}. Afterwards the projection images, comparable to Figure \ref{edgeimages} a), are projected onto the plane perpendicular to the edge to improve the statistic and reduce the image noise. This procedure is comparable with a line-plot over each pixel row and a subsequent averaging over all pixel rows. This projection of the edge shows the intensity variation between the different pixel. Such a projection of the edge-profile or the corresponding \gls{esf} is shown at the top of Figure\ref{errorgauss}. The shape of the profile reminds to a blurred step function. This shape can be roughly split in three parts. One part which has none intensity, because inside the cuboid the X-rays are almost completely absorbed. Another part with high intensity in each pixel, because no absorbing material is inside the beam. These two parts lead to a horizontal line, because the neighbouring pixel have the same intensity values, but of course with antithetic values. Finally the third part right in between the other parts, which is the projection of the edge itself. There the shape of the projection is a increasing or decreasing line (depending on the projection direction), with a more or less steep slope, which is correlated to the geometrical unsharpness and the misalignment of the edge. On this shape a error-function is fitted to get parameters for the comparison of the different \glspl{esf}. Since the best angle corresponds to the steepest \gls{esf}, the slope of the fit-functions is plotted against the different angles. \textcolor{red}{do here the processing of the edge alignment generating such a plot} This results in a parabola, whereby the vertex of the parabola indicates the best edge position. If the edge was well aligned in the first place the value of the best angle should be near start value. This procedure is at first done in rough steps likewise in both directions around the start angle and afterwards with finer steps around the best value of the first measurement. 

\paragraph{Measurement procedure}
After adjustment of the edge, the main measurement starts. Therefore the edge is measured at three different distances with respect to the source. Usually one distance is sufficient for the determination of the \gls{psf} and the corresponding spot size, but with three different distances the exploration of the influence of the magnification onto the measurement results is possible. 
\begin{figure}%[t]
	\begin{center}
		\includegraphics[width = 14.7cm,keepaspectratio =true]{edgedist}
	\end{center}
	\caption[Illustration of the different edge positions for the measurement]{\textit{Illustration of the different edge positions during the measurement. Due to magnification the projection of the edge is spread over the detector plain perpendicular to the edge direction. The edge is placed on the Euler cradle, which is not shown here. To get a easier insight of the different arrangements a small coordinate system is placed right in front of the detector screen. }}
	\label{edgedist}
\end{figure}
The different distances are chosen to be close to the source plane to reduce the influence of the detector \gls{psf} and also to get a sufficient magnification of the edge resolving the spot-size of the source. This need showed up, because during the first measurements the determination neither of the \gls{psf} nor of the spot size was possible, since the pixels and the \acrshort{psf} of the flat-panel detector are to big. The distances and the cuboid dimensions for the measurement are exhibited in Figure \ref{edgedist}. The distance between the different positions is equidistantly set to $15\,$cm, at one hand for reasons of simplicity and at the other because the Euler-cradle has also a limited traverse paths in every direction. The edge is at first slightly tilted around$\approx 3\,$째 at the z-axes (cf. Figure \ref{edgeimages} a)), to provide a better resolution for the projection of the edge-profile. At each of the particular z-positions a \gls{flat} is taken. Afterwards the edge is placed in three different directions in the beam, one vertical, the second horizontal and the third at the bisecting line of the first two positions, around the z-axis. After a short waiting time, to decrease vibrations induced by the driving around of the Euler-cradle, an image at each particular position is taken. With this approach it is possible to determine the shape of the spot-size and also the rotation of the source-shape in the x-y-plane at once. Thanks to the possibility to control every stage in the setup from outside, only the adjustment on the sample holder of the Euler-cradle is necessary and the measurement itself is done automatically using a control script, containing the different positions and parameter. This measurement is done for three different energies at $40,60$ and $80\,$kV and thereby repeated in feasible steps over the whole power range. This implies e.g. for a photon energy of $60\,$kVp a range of $160\,$ Watt, leading to over 50 measurements, whereby every measurement contains $9$ projection images and three \glspl{flat} (one for each z-position).  With this images at hand, the determination of the \gls{psf} of the system is possible, but for the determination of the source-size an additional measurement is needed.\\

To evaluate the source size, also the \gls{psf} of the Detector has to be determined. As mentioned in section \ref{subsec:complpsf} are the results of the described measurement above the convolution of the source and the detector, \gls{psf} respectively. The approach is very similar to the upper case, but also much less time extensive. To determine the \gls{psf} of the detector, the same edge is placed right in front of the detector plane. With this it is made sure that the influence of the source is negligible, because the \gls{psf} of the source scales with a factor of $M-1$ and for the position of the edge right in front of the detector the magnification is in good approximation unity. The edge is placed again in vertical as well as in horizontal direction, but due to the lack of a feasible sample holder a measurement diagonally to the pixel was not possible. But this problem can be easily solved during the processing by quadratic addition of the vertical and horizontal value to get a measure for the diagonal \gls{psf} as explained in the next section. This measurement is also repeated for the different energies, because the \gls{psf} of the detector can not necessarily expected to be constant for different energies. 
\subsection{Data processing}\label{subsec:edgeprocessing}
For reasons of simplicity, this section just considers the processing of a data-set of one energy, in this case the one for $60\,$kV, because the treatment of the data-sets is for every energy the same, disregarding some changes in the projection angle or some computing parameters. To get the information out of the projected edge-profiles, the images are at first corrected with the corresponding \gls{flat}. After that a rectangular section of about $250\times250$ pixel, which only contains the blurred edge, is cut out of the images to reduce computing time.
\begin{figure}[h]
	\begin{center}
		\includegraphics[width = 9.7 cm,keepaspectratio = true]{projanglerot}
	\end{center}
	\caption[Illustration of the projection of an edge profile ]{\textit{Projection of a tilted edge onto a plane perpendicular to the edge direction. Each pixel is projected under the same angle onto the projection plane. With this technique the two dimensional edge image is reduced to a one-dimensional trace known ak the \gls{esf}. \tiny{(adapted from \citep{Samei1998})}}}
	\label{edgeangle}
\end{figure}
This section is then projected perpendicular to the edge direction (cf. Figure \ref{edgeangle}), to get a \gls{esf} with a good statistic. To assure that the projection is accurately done to the plane perpendicular to the edge, the same procedure as in section \ref{subsec:knifedata} (edge alignment) is followed, with the difference that here the projector gets on purpose wrong projection angles. For this determination one image of the whole data set with a vertical oriented edge is sufficient, because the angles for the other projection directions are correlated to each other due to the Euler cradle and can be adjusted by simply adding $90\,$째 for the horizontal case or $45$째 for the diagonal case, to the projector angle. 
\begin{figure}[h]
	\begin{center}
		\includegraphics[width = 14.5 cm,keepaspectratio = true]{errorgauss}
	\end{center}
	\caption[Fit of the projection of the projected edge and corresponding Gauss-fits]{\textit{Illustration of The projected edge-profile with the associated fitted error-function, and the resulting Gauss-fits. Top: Plot of three projected edges and their corresponding error-function fit for three different magnifications, respectively. Bottom: Plot of the Gaussian functions fitted with the acquired fit parameter of the error-functions above. The \gls{fwhm} of these fits is needed to determine the spot-size of the source.}}
	\label{errorgauss}
\end{figure}
For this data-set a image of a nearly vertical edge at the second measurement position ($z_{2}$) with a power of $80\,$Watt is chosen. With the projection angle found by this analysis, the whole data-set is projected afterwards. As mentioned above, the edge is slightly tilted from the usual coordinate axes. Using this treatment it is possible to get a sub-pixel resolution in the projected image, because the projector can split in this case each pixel by a certain number of sub-pixels and thus enhance resolution of the \gls{esf}. The splitting of one pixel in several sub-pixel is just accurately possible with a tilted edge, because every possible shadowing setting of a detector pixel occurs. In contrast to that, for a edge exactly vertically aligned to the pixel rows only tree possible shadowing settings occur, either the edge covers the whole pixel, the edge do not cover the pixel, or the edge is somewhere in the middle of the pixel.\\

To facilitate the further steps the \gls{esf} is normed between zero and one. On this normed \gls{esf} again a error-function is fitted. As shown in section \ref{subsec:esflsf} is the \gls{lsf} the first derivative of the \gls{esf} and in this case the first derivative of an error-function results in a Gaussian-function. For that reason the parameter of the error-functions can be taken to fit the \gls{psf} of the system. To get a better imagination what happens at the particular processing steps Figure \ref{errorgauss} shows some results for the error-function fit and the Gaussian fit. The plots show the results for the case of a vertical edge at an energy of $60\,$kV and a power of $80$ W, for the different edge distances. The top plot shows the \gls{esf} with the corresponding fit of the error-function, and the plot below the related Gaussian fits. As one can clearly see is the influence of the magnification onto the width tremendous, but after correction with the respective factor the tree curves should have the same width. As suggested in the latter section for the determination of the source size also the \gls{psf} of the detector is needed. The extraction of the \gls{psf} out of the raw images is the same as for the other measurements and is for that reason not explained in further detail. Only for the detector PSF in the diagonal direction and their corresponding \gls{fwhm} an additional step is needed. As the adjustment of the edge diagonal to the pixel was not possible, the PSF for this direction is determined using simple mathematical and geometrical considerations. The diagonal detector PSF is determined by quadratic multiplication of the vertical and horizontal detector \gls{psf}.   With this at hand the spot-size of the source can be determined for the three directions. Therefore the equation \ref{spotwidth} of section \ref{subsec:complpsf} is rearranged to:
\begin{equation}
\sigma_{source} = \frac{\sqrt{\sigma_{system}^{2}-\sigma_{detector}^{2}}}{M-1},
\end{equation}
and afterwards multiplied by $2\sqrt{2 ln2}$, which finally yields to the \gls{fwhmg} of the source size in one direction and for one distinct power:
\begin{equation}
FWHM_{source} = \frac{\sqrt{FWHM_{system}^{2}-FWHM_{detector}^{2}}}{M-1},
\end{equation}
whereby $M$ denotes the different magnification factors for the different distances of the source. With this equation the determination of the spot-size in the three different directions is possible. In the next section the results for the different measurements are discussed in further detail.      
\subsection{Results}\label{subsec:edgeresults}
\paragraph{Detector PSF}

\paragraph{Source spot-size}
\begin{figure}
	\begin{center}
		\includegraphics[width= 14.7 cm,keepaspectratio = true]{60kvpcombi}
	\end{center}
\end{figure}
\paragraph{Shape of the source-spot}





\section{Measurements using a Resolution-target}\label{sec:targetmeasurements}
\subsection{Data acquisition}\label{subsec:targetdata}
\paragraph{Measurement procedure}
\subsection{Data processing}\label{subsec:targetprocessing}